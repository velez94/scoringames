"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.CompetitionsStack = void 0;
const cdk = require("aws-cdk-lib");
const dynamodb = require("aws-cdk-lib/aws-dynamodb");
const lambda = require("aws-cdk-lib/aws-lambda");
const events = require("aws-cdk-lib/aws-events");
const constructs_1 = require("constructs");
class CompetitionsStack extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        // Domain-specific EventBridge Bus
        this.competitionsEventBus = new events.EventBus(this, 'CompetitionsEventBus', {
            eventBusName: `competitions-domain-${props.stage}`,
        });
        // Events Table
        this.eventsTable = new dynamodb.Table(this, 'EventsTable', {
            partitionKey: { name: 'eventId', type: dynamodb.AttributeType.STRING },
            billingMode: dynamodb.BillingMode.PAY_PER_REQUEST,
            removalPolicy: cdk.RemovalPolicy.DESTROY,
        });
        this.eventsTable.addGlobalSecondaryIndex({
            indexName: 'status-index',
            partitionKey: { name: 'status', type: dynamodb.AttributeType.STRING },
            sortKey: { name: 'startDate', type: dynamodb.AttributeType.STRING },
        });
        // Event Days Table
        this.eventDaysTable = new dynamodb.Table(this, 'EventDaysTable', {
            partitionKey: { name: 'eventId', type: dynamodb.AttributeType.STRING },
            sortKey: { name: 'dayId', type: dynamodb.AttributeType.STRING },
            billingMode: dynamodb.BillingMode.PAY_PER_REQUEST,
            removalPolicy: cdk.RemovalPolicy.DESTROY,
        });
        // Competitions Lambda
        this.competitionsLambda = new lambda.Function(this, 'CompetitionsLambda', {
            runtime: lambda.Runtime.NODEJS_18_X,
            handler: 'index.handler',
            code: lambda.Code.fromAsset('lambda/competitions'),
            timeout: cdk.Duration.seconds(30),
            memorySize: 256,
            environment: {
                EVENTS_TABLE: this.eventsTable.tableName,
                EVENT_DAYS_TABLE: this.eventDaysTable.tableName,
                EVENT_IMAGES_BUCKET: props.eventImagesBucket.bucketName,
                ORGANIZATION_EVENTS_TABLE: props.organizationEventsTable.tableName,
                ORGANIZATION_MEMBERS_TABLE: props.organizationMembersTable.tableName,
                SCORING_SYSTEMS_TABLE: props.scoringSystemsTable.tableName,
                DOMAIN_EVENT_BUS: this.competitionsEventBus.eventBusName,
                CENTRAL_EVENT_BUS: props.eventBus.eventBusName,
            },
        });
        // Grant permissions
        this.eventsTable.grantReadWriteData(this.competitionsLambda);
        this.eventDaysTable.grantReadWriteData(this.competitionsLambda);
        props.eventImagesBucket.grantPut(this.competitionsLambda);
        props.organizationEventsTable.grantReadWriteData(this.competitionsLambda);
        props.organizationMembersTable.grantReadData(this.competitionsLambda);
        props.scoringSystemsTable.grantReadData(this.competitionsLambda);
        this.competitionsEventBus.grantPutEventsTo(this.competitionsLambda);
        props.eventBus.grantPutEventsTo(this.competitionsLambda);
        // Outputs
    }
}
exports.CompetitionsStack = CompetitionsStack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tcGV0aXRpb25zLXN0YWNrLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiY29tcGV0aXRpb25zLXN0YWNrLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLG1DQUFtQztBQUNuQyxxREFBcUQ7QUFDckQsaURBQWlEO0FBRWpELGlEQUFpRDtBQUVqRCwyQ0FBdUM7QUFXdkMsTUFBYSxpQkFBa0IsU0FBUSxzQkFBUztJQU05QyxZQUFZLEtBQWdCLEVBQUUsRUFBVSxFQUFFLEtBQTZCO1FBQ3JFLEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFFakIsa0NBQWtDO1FBQ2xDLElBQUksQ0FBQyxvQkFBb0IsR0FBRyxJQUFJLE1BQU0sQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLHNCQUFzQixFQUFFO1lBQzVFLFlBQVksRUFBRSx1QkFBdUIsS0FBSyxDQUFDLEtBQUssRUFBRTtTQUNuRCxDQUFDLENBQUM7UUFFSCxlQUFlO1FBQ2YsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLFFBQVEsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLGFBQWEsRUFBRTtZQUN6RCxZQUFZLEVBQUUsRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxRQUFRLENBQUMsYUFBYSxDQUFDLE1BQU0sRUFBRTtZQUN0RSxXQUFXLEVBQUUsUUFBUSxDQUFDLFdBQVcsQ0FBQyxlQUFlO1lBQ2pELGFBQWEsRUFBRSxHQUFHLENBQUMsYUFBYSxDQUFDLE9BQU87U0FDekMsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLFdBQVcsQ0FBQyx1QkFBdUIsQ0FBQztZQUN2QyxTQUFTLEVBQUUsY0FBYztZQUN6QixZQUFZLEVBQUUsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxRQUFRLENBQUMsYUFBYSxDQUFDLE1BQU0sRUFBRTtZQUNyRSxPQUFPLEVBQUUsRUFBRSxJQUFJLEVBQUUsV0FBVyxFQUFFLElBQUksRUFBRSxRQUFRLENBQUMsYUFBYSxDQUFDLE1BQU0sRUFBRTtTQUNwRSxDQUFDLENBQUM7UUFFSCxtQkFBbUI7UUFDbkIsSUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLFFBQVEsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLGdCQUFnQixFQUFFO1lBQy9ELFlBQVksRUFBRSxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLFFBQVEsQ0FBQyxhQUFhLENBQUMsTUFBTSxFQUFFO1lBQ3RFLE9BQU8sRUFBRSxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLFFBQVEsQ0FBQyxhQUFhLENBQUMsTUFBTSxFQUFFO1lBQy9ELFdBQVcsRUFBRSxRQUFRLENBQUMsV0FBVyxDQUFDLGVBQWU7WUFDakQsYUFBYSxFQUFFLEdBQUcsQ0FBQyxhQUFhLENBQUMsT0FBTztTQUN6QyxDQUFDLENBQUM7UUFFSCxzQkFBc0I7UUFDdEIsSUFBSSxDQUFDLGtCQUFrQixHQUFHLElBQUksTUFBTSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsb0JBQW9CLEVBQUU7WUFDeEUsT0FBTyxFQUFFLE1BQU0sQ0FBQyxPQUFPLENBQUMsV0FBVztZQUNuQyxPQUFPLEVBQUUsZUFBZTtZQUN4QixJQUFJLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMscUJBQXFCLENBQUM7WUFDbEQsT0FBTyxFQUFFLEdBQUcsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQztZQUNqQyxVQUFVLEVBQUUsR0FBRztZQUNmLFdBQVcsRUFBRTtnQkFDWCxZQUFZLEVBQUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxTQUFTO2dCQUN4QyxnQkFBZ0IsRUFBRSxJQUFJLENBQUMsY0FBYyxDQUFDLFNBQVM7Z0JBQy9DLG1CQUFtQixFQUFFLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxVQUFVO2dCQUN2RCx5QkFBeUIsRUFBRSxLQUFLLENBQUMsdUJBQXVCLENBQUMsU0FBUztnQkFDbEUsMEJBQTBCLEVBQUUsS0FBSyxDQUFDLHdCQUF3QixDQUFDLFNBQVM7Z0JBQ3BFLHFCQUFxQixFQUFFLEtBQUssQ0FBQyxtQkFBbUIsQ0FBQyxTQUFTO2dCQUMxRCxnQkFBZ0IsRUFBRSxJQUFJLENBQUMsb0JBQW9CLENBQUMsWUFBWTtnQkFDeEQsaUJBQWlCLEVBQUUsS0FBSyxDQUFDLFFBQVEsQ0FBQyxZQUFZO2FBQy9DO1NBQ0YsQ0FBQyxDQUFDO1FBRUgsb0JBQW9CO1FBQ3BCLElBQUksQ0FBQyxXQUFXLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLENBQUM7UUFDN0QsSUFBSSxDQUFDLGNBQWMsQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsQ0FBQztRQUNoRSxLQUFLLENBQUMsaUJBQWlCLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1FBQzFELEtBQUssQ0FBQyx1QkFBdUIsQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsQ0FBQztRQUMxRSxLQUFLLENBQUMsd0JBQXdCLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1FBQ3RFLEtBQUssQ0FBQyxtQkFBbUIsQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLENBQUM7UUFDakUsSUFBSSxDQUFDLG9CQUFvQixDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1FBQ3BFLEtBQUssQ0FBQyxRQUFRLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLENBQUM7UUFFekQsVUFBVTtJQUNaLENBQUM7Q0FDRjtBQWxFRCw4Q0FrRUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBjZGsgZnJvbSAnYXdzLWNkay1saWInO1xuaW1wb3J0ICogYXMgZHluYW1vZGIgZnJvbSAnYXdzLWNkay1saWIvYXdzLWR5bmFtb2RiJztcbmltcG9ydCAqIGFzIGxhbWJkYSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtbGFtYmRhJztcbmltcG9ydCAqIGFzIGFwaWdhdGV3YXkgZnJvbSAnYXdzLWNkay1saWIvYXdzLWFwaWdhdGV3YXknO1xuaW1wb3J0ICogYXMgZXZlbnRzIGZyb20gJ2F3cy1jZGstbGliL2F3cy1ldmVudHMnO1xuaW1wb3J0ICogYXMgczMgZnJvbSAnYXdzLWNkay1saWIvYXdzLXMzJztcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xuXG5leHBvcnQgaW50ZXJmYWNlIENvbXBldGl0aW9uc1N0YWNrUHJvcHMgIHtcbiAgc3RhZ2U6IHN0cmluZztcbiAgZXZlbnRCdXM6IGV2ZW50cy5FdmVudEJ1cztcbiAgZXZlbnRJbWFnZXNCdWNrZXQ6IHMzLkJ1Y2tldDtcbiAgb3JnYW5pemF0aW9uRXZlbnRzVGFibGU6IGR5bmFtb2RiLlRhYmxlO1xuICBvcmdhbml6YXRpb25NZW1iZXJzVGFibGU6IGR5bmFtb2RiLlRhYmxlO1xuICBzY29yaW5nU3lzdGVtc1RhYmxlOiBkeW5hbW9kYi5UYWJsZTtcbn1cblxuZXhwb3J0IGNsYXNzIENvbXBldGl0aW9uc1N0YWNrIGV4dGVuZHMgQ29uc3RydWN0IHtcbiAgcHVibGljIHJlYWRvbmx5IGV2ZW50c1RhYmxlOiBkeW5hbW9kYi5UYWJsZTtcbiAgcHVibGljIHJlYWRvbmx5IGV2ZW50RGF5c1RhYmxlOiBkeW5hbW9kYi5UYWJsZTtcbiAgcHVibGljIHJlYWRvbmx5IGNvbXBldGl0aW9uc0V2ZW50QnVzOiBldmVudHMuRXZlbnRCdXM7XG4gIHB1YmxpYyByZWFkb25seSBjb21wZXRpdGlvbnNMYW1iZGE6IGxhbWJkYS5GdW5jdGlvbjtcblxuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wczogQ29tcGV0aXRpb25zU3RhY2tQcm9wcykge1xuICAgIHN1cGVyKHNjb3BlLCBpZCk7XG5cbiAgICAvLyBEb21haW4tc3BlY2lmaWMgRXZlbnRCcmlkZ2UgQnVzXG4gICAgdGhpcy5jb21wZXRpdGlvbnNFdmVudEJ1cyA9IG5ldyBldmVudHMuRXZlbnRCdXModGhpcywgJ0NvbXBldGl0aW9uc0V2ZW50QnVzJywge1xuICAgICAgZXZlbnRCdXNOYW1lOiBgY29tcGV0aXRpb25zLWRvbWFpbi0ke3Byb3BzLnN0YWdlfWAsXG4gICAgfSk7XG5cbiAgICAvLyBFdmVudHMgVGFibGVcbiAgICB0aGlzLmV2ZW50c1RhYmxlID0gbmV3IGR5bmFtb2RiLlRhYmxlKHRoaXMsICdFdmVudHNUYWJsZScsIHtcbiAgICAgIHBhcnRpdGlvbktleTogeyBuYW1lOiAnZXZlbnRJZCcsIHR5cGU6IGR5bmFtb2RiLkF0dHJpYnV0ZVR5cGUuU1RSSU5HIH0sXG4gICAgICBiaWxsaW5nTW9kZTogZHluYW1vZGIuQmlsbGluZ01vZGUuUEFZX1BFUl9SRVFVRVNULFxuICAgICAgcmVtb3ZhbFBvbGljeTogY2RrLlJlbW92YWxQb2xpY3kuREVTVFJPWSxcbiAgICB9KTtcblxuICAgIHRoaXMuZXZlbnRzVGFibGUuYWRkR2xvYmFsU2Vjb25kYXJ5SW5kZXgoe1xuICAgICAgaW5kZXhOYW1lOiAnc3RhdHVzLWluZGV4JyxcbiAgICAgIHBhcnRpdGlvbktleTogeyBuYW1lOiAnc3RhdHVzJywgdHlwZTogZHluYW1vZGIuQXR0cmlidXRlVHlwZS5TVFJJTkcgfSxcbiAgICAgIHNvcnRLZXk6IHsgbmFtZTogJ3N0YXJ0RGF0ZScsIHR5cGU6IGR5bmFtb2RiLkF0dHJpYnV0ZVR5cGUuU1RSSU5HIH0sXG4gICAgfSk7XG5cbiAgICAvLyBFdmVudCBEYXlzIFRhYmxlXG4gICAgdGhpcy5ldmVudERheXNUYWJsZSA9IG5ldyBkeW5hbW9kYi5UYWJsZSh0aGlzLCAnRXZlbnREYXlzVGFibGUnLCB7XG4gICAgICBwYXJ0aXRpb25LZXk6IHsgbmFtZTogJ2V2ZW50SWQnLCB0eXBlOiBkeW5hbW9kYi5BdHRyaWJ1dGVUeXBlLlNUUklORyB9LFxuICAgICAgc29ydEtleTogeyBuYW1lOiAnZGF5SWQnLCB0eXBlOiBkeW5hbW9kYi5BdHRyaWJ1dGVUeXBlLlNUUklORyB9LFxuICAgICAgYmlsbGluZ01vZGU6IGR5bmFtb2RiLkJpbGxpbmdNb2RlLlBBWV9QRVJfUkVRVUVTVCxcbiAgICAgIHJlbW92YWxQb2xpY3k6IGNkay5SZW1vdmFsUG9saWN5LkRFU1RST1ksXG4gICAgfSk7XG5cbiAgICAvLyBDb21wZXRpdGlvbnMgTGFtYmRhXG4gICAgdGhpcy5jb21wZXRpdGlvbnNMYW1iZGEgPSBuZXcgbGFtYmRhLkZ1bmN0aW9uKHRoaXMsICdDb21wZXRpdGlvbnNMYW1iZGEnLCB7XG4gICAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5OT0RFSlNfMThfWCxcbiAgICAgIGhhbmRsZXI6ICdpbmRleC5oYW5kbGVyJyxcbiAgICAgIGNvZGU6IGxhbWJkYS5Db2RlLmZyb21Bc3NldCgnbGFtYmRhL2NvbXBldGl0aW9ucycpLFxuICAgICAgdGltZW91dDogY2RrLkR1cmF0aW9uLnNlY29uZHMoMzApLFxuICAgICAgbWVtb3J5U2l6ZTogMjU2LFxuICAgICAgZW52aXJvbm1lbnQ6IHtcbiAgICAgICAgRVZFTlRTX1RBQkxFOiB0aGlzLmV2ZW50c1RhYmxlLnRhYmxlTmFtZSxcbiAgICAgICAgRVZFTlRfREFZU19UQUJMRTogdGhpcy5ldmVudERheXNUYWJsZS50YWJsZU5hbWUsXG4gICAgICAgIEVWRU5UX0lNQUdFU19CVUNLRVQ6IHByb3BzLmV2ZW50SW1hZ2VzQnVja2V0LmJ1Y2tldE5hbWUsXG4gICAgICAgIE9SR0FOSVpBVElPTl9FVkVOVFNfVEFCTEU6IHByb3BzLm9yZ2FuaXphdGlvbkV2ZW50c1RhYmxlLnRhYmxlTmFtZSxcbiAgICAgICAgT1JHQU5JWkFUSU9OX01FTUJFUlNfVEFCTEU6IHByb3BzLm9yZ2FuaXphdGlvbk1lbWJlcnNUYWJsZS50YWJsZU5hbWUsXG4gICAgICAgIFNDT1JJTkdfU1lTVEVNU19UQUJMRTogcHJvcHMuc2NvcmluZ1N5c3RlbXNUYWJsZS50YWJsZU5hbWUsXG4gICAgICAgIERPTUFJTl9FVkVOVF9CVVM6IHRoaXMuY29tcGV0aXRpb25zRXZlbnRCdXMuZXZlbnRCdXNOYW1lLFxuICAgICAgICBDRU5UUkFMX0VWRU5UX0JVUzogcHJvcHMuZXZlbnRCdXMuZXZlbnRCdXNOYW1lLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIC8vIEdyYW50IHBlcm1pc3Npb25zXG4gICAgdGhpcy5ldmVudHNUYWJsZS5ncmFudFJlYWRXcml0ZURhdGEodGhpcy5jb21wZXRpdGlvbnNMYW1iZGEpO1xuICAgIHRoaXMuZXZlbnREYXlzVGFibGUuZ3JhbnRSZWFkV3JpdGVEYXRhKHRoaXMuY29tcGV0aXRpb25zTGFtYmRhKTtcbiAgICBwcm9wcy5ldmVudEltYWdlc0J1Y2tldC5ncmFudFB1dCh0aGlzLmNvbXBldGl0aW9uc0xhbWJkYSk7XG4gICAgcHJvcHMub3JnYW5pemF0aW9uRXZlbnRzVGFibGUuZ3JhbnRSZWFkV3JpdGVEYXRhKHRoaXMuY29tcGV0aXRpb25zTGFtYmRhKTtcbiAgICBwcm9wcy5vcmdhbml6YXRpb25NZW1iZXJzVGFibGUuZ3JhbnRSZWFkRGF0YSh0aGlzLmNvbXBldGl0aW9uc0xhbWJkYSk7XG4gICAgcHJvcHMuc2NvcmluZ1N5c3RlbXNUYWJsZS5ncmFudFJlYWREYXRhKHRoaXMuY29tcGV0aXRpb25zTGFtYmRhKTtcbiAgICB0aGlzLmNvbXBldGl0aW9uc0V2ZW50QnVzLmdyYW50UHV0RXZlbnRzVG8odGhpcy5jb21wZXRpdGlvbnNMYW1iZGEpO1xuICAgIHByb3BzLmV2ZW50QnVzLmdyYW50UHV0RXZlbnRzVG8odGhpcy5jb21wZXRpdGlvbnNMYW1iZGEpO1xuXG4gICAgLy8gT3V0cHV0c1xuICB9XG59XG4iXX0=