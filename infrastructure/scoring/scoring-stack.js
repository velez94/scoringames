"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ScoringStack = void 0;
const cdk = require("aws-cdk-lib");
const dynamodb = require("aws-cdk-lib/aws-dynamodb");
const lambda = require("aws-cdk-lib/aws-lambda");
const events = require("aws-cdk-lib/aws-events");
const targets = require("aws-cdk-lib/aws-events-targets");
const constructs_1 = require("constructs");
class ScoringStack extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        // Domain-specific EventBridge Bus
        this.scoringEventBus = new events.EventBus(this, 'ScoringEventBus', {
            eventBusName: `scoring-domain-${props.stage}`,
        });
        // Scores Table
        this.scoresTable = new dynamodb.Table(this, 'ScoresTable', {
            partitionKey: { name: 'eventId', type: dynamodb.AttributeType.STRING },
            sortKey: { name: 'scoreId', type: dynamodb.AttributeType.STRING },
            billingMode: dynamodb.BillingMode.PAY_PER_REQUEST,
            removalPolicy: cdk.RemovalPolicy.DESTROY,
        });
        this.scoresTable.addGlobalSecondaryIndex({
            indexName: 'athlete-scores-index',
            partitionKey: { name: 'athleteId', type: dynamodb.AttributeType.STRING },
            sortKey: { name: 'eventId', type: dynamodb.AttributeType.STRING },
        });
        // Scoring Systems Table
        this.scoringSystemsTable = new dynamodb.Table(this, 'ScoringSystemsTable', {
            partitionKey: { name: 'eventId', type: dynamodb.AttributeType.STRING },
            sortKey: { name: 'scoringSystemId', type: dynamodb.AttributeType.STRING },
            billingMode: dynamodb.BillingMode.PAY_PER_REQUEST,
            removalPolicy: cdk.RemovalPolicy.DESTROY,
        });
        // Leaderboard Cache Table
        this.leaderboardCacheTable = new dynamodb.Table(this, 'LeaderboardCacheTable', {
            partitionKey: { name: 'leaderboardId', type: dynamodb.AttributeType.STRING },
            billingMode: dynamodb.BillingMode.PAY_PER_REQUEST,
            timeToLiveAttribute: 'ttl',
            removalPolicy: cdk.RemovalPolicy.DESTROY,
        });
        this.leaderboardCacheTable.addGlobalSecondaryIndex({
            indexName: 'event-leaderboards-index',
            partitionKey: { name: 'eventId', type: dynamodb.AttributeType.STRING },
        });
        // Exercise Library Table
        this.exerciseLibraryTable = new dynamodb.Table(this, 'ExerciseLibraryTable', {
            partitionKey: { name: 'exerciseId', type: dynamodb.AttributeType.STRING },
            billingMode: dynamodb.BillingMode.PAY_PER_REQUEST,
            removalPolicy: cdk.RemovalPolicy.DESTROY,
        });
        // Scores Lambda
        this.scoresLambda = new lambda.Function(this, 'ScoresLambda', {
            runtime: lambda.Runtime.NODEJS_18_X,
            handler: 'index.handler',
            code: lambda.Code.fromAsset('lambda/scoring'),
            timeout: cdk.Duration.seconds(30),
            memorySize: 256,
            environment: {
                SCORES_TABLE: this.scoresTable.tableName,
                SCORING_SYSTEMS_TABLE: this.scoringSystemsTable.tableName,
                DOMAIN_EVENT_BUS: this.scoringEventBus.eventBusName,
                CENTRAL_EVENT_BUS: props.eventBus.eventBusName,
            },
        });
        this.scoresTable.grantReadWriteData(this.scoresLambda);
        this.scoringSystemsTable.grantReadData(this.scoresLambda);
        this.scoringEventBus.grantPutEventsTo(this.scoresLambda);
        props.eventBus.grantPutEventsTo(this.scoresLambda);
        // Leaderboard API Lambda
        const leaderboardLambda = new lambda.Function(this, 'LeaderboardLambda', {
            runtime: lambda.Runtime.NODEJS_18_X,
            handler: 'leaderboard-api.handler',
            code: lambda.Code.fromAsset('lambda/scoring'),
            timeout: cdk.Duration.seconds(30),
            memorySize: 256,
            environment: {
                LEADERBOARD_TABLE: this.leaderboardCacheTable.tableName,
                SCORES_TABLE: this.scoresTable.tableName,
            },
        });
        this.leaderboardCacheTable.grantReadData(leaderboardLambda);
        this.scoresTable.grantReadData(leaderboardLambda);
        // Leaderboard Calculator Lambda
        const calculatorLambda = new lambda.Function(this, 'LeaderboardCalculator', {
            runtime: lambda.Runtime.NODEJS_18_X,
            handler: 'leaderboard-calculator.handler',
            code: lambda.Code.fromAsset('lambda/scoring'),
            timeout: cdk.Duration.seconds(60),
            memorySize: 512,
            environment: {
                SCORES_TABLE: this.scoresTable.tableName,
                LEADERBOARD_TABLE: this.leaderboardCacheTable.tableName,
            },
        });
        this.scoresTable.grantReadData(calculatorLambda);
        this.leaderboardCacheTable.grantReadWriteData(calculatorLambda);
        // EventBridge rule for leaderboard updates
        new events.Rule(this, 'ScoreCalculatedRule', {
            eventBus: this.scoringEventBus,
            eventPattern: {
                source: ['scoringames.scores'],
                detailType: ['ScoreCalculated'],
            },
            targets: [new targets.LambdaFunction(calculatorLambda)],
        });
        // Scoring Systems Lambda
        const scoringSystemsLambda = new lambda.Function(this, 'ScoringSystemsLambda', {
            runtime: lambda.Runtime.NODEJS_18_X,
            handler: 'systems.handler',
            code: lambda.Code.fromAsset('lambda/scoring'),
            timeout: cdk.Duration.seconds(30),
            memorySize: 256,
            environment: {
                SCORING_SYSTEMS_TABLE: this.scoringSystemsTable.tableName,
            },
        });
        this.scoringSystemsTable.grantReadWriteData(scoringSystemsLambda);
        // Exercise Library Lambda
        this.exercisesLambda = new lambda.Function(this, 'ExercisesLambda', {
            runtime: lambda.Runtime.NODEJS_18_X,
            handler: 'exercises.handler',
            code: lambda.Code.fromAsset('lambda/scoring'),
            timeout: cdk.Duration.seconds(30),
            memorySize: 256,
            environment: {
                EXERCISE_LIBRARY_TABLE: this.exerciseLibraryTable.tableName,
            },
        });
        this.exerciseLibraryTable.grantReadWriteData(this.exercisesLambda);
        // Outputs
    }
}
exports.ScoringStack = ScoringStack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2NvcmluZy1zdGFjay5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInNjb3Jpbmctc3RhY2sudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsbUNBQW1DO0FBQ25DLHFEQUFxRDtBQUNyRCxpREFBaUQ7QUFFakQsaURBQWlEO0FBQ2pELDBEQUEwRDtBQUMxRCwyQ0FBdUM7QUFNdkMsTUFBYSxZQUFhLFNBQVEsc0JBQVM7SUFTekMsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxLQUF3QjtRQUNoRSxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWpCLGtDQUFrQztRQUNsQyxJQUFJLENBQUMsZUFBZSxHQUFHLElBQUksTUFBTSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsaUJBQWlCLEVBQUU7WUFDbEUsWUFBWSxFQUFFLGtCQUFrQixLQUFLLENBQUMsS0FBSyxFQUFFO1NBQzlDLENBQUMsQ0FBQztRQUVILGVBQWU7UUFDZixJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksUUFBUSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsYUFBYSxFQUFFO1lBQ3pELFlBQVksRUFBRSxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLFFBQVEsQ0FBQyxhQUFhLENBQUMsTUFBTSxFQUFFO1lBQ3RFLE9BQU8sRUFBRSxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLFFBQVEsQ0FBQyxhQUFhLENBQUMsTUFBTSxFQUFFO1lBQ2pFLFdBQVcsRUFBRSxRQUFRLENBQUMsV0FBVyxDQUFDLGVBQWU7WUFDakQsYUFBYSxFQUFFLEdBQUcsQ0FBQyxhQUFhLENBQUMsT0FBTztTQUN6QyxDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsV0FBVyxDQUFDLHVCQUF1QixDQUFDO1lBQ3ZDLFNBQVMsRUFBRSxzQkFBc0I7WUFDakMsWUFBWSxFQUFFLEVBQUUsSUFBSSxFQUFFLFdBQVcsRUFBRSxJQUFJLEVBQUUsUUFBUSxDQUFD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QyxrQkFBa0IsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO1FBRWxFLDBCQUEwQjtRQUMxQixJQUFJLENBQUMsZUFBZSxHQUFHLElBQUksTUFBTSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsaUJBQWlCLEVBQUU7WUFDbEUsT0FBTyxFQUFFLE1BQU0sQ0FBQyxPQUFPLENBQUMsV0FBVztZQUNuQyxPQUFPLEVBQUUsbUJBQW1CO1lBQzVCLElBQUksRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxnQkFBZ0IsQ0FBQztZQUM3QyxPQUFPLEVBQUUsR0FBRyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDO1lBQ2pDLFVBQVUsRUFBRSxHQUFHO1lBQ2YsV0FBVyxFQUFFO2dCQUNYLHNCQUFzQixFQUFFLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxTQUFTO2FBQzVEO1NBQ0YsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLG9CQUFvQixDQUFDLGtCQUFrQixDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQztRQUVuRSxVQUFVO0lBQ1osQ0FBQztDQUNGO0FBdkpELG9DQXVKQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGNkayBmcm9tICdhd3MtY2RrLWxpYic7XG5pbXBvcnQgKiBhcyBkeW5hbW9kYiBmcm9tICdhd3MtY2RrLWxpYi9hd3MtZHluYW1vZGInO1xuaW1wb3J0ICogYXMgbGFtYmRhIGZyb20gJ2F3cy1jZGstbGliL2F3cy1sYW1iZGEnO1xuaW1wb3J0ICogYXMgYXBpZ2F0ZXdheSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtYXBpZ2F0ZXdheSc7XG5pbXBvcnQgKiBhcyBldmVudHMgZnJvbSAnYXdzLWNkay1saWIvYXdzLWV2ZW50cyc7XG5pbXBvcnQgKiBhcyB0YXJnZXRzIGZyb20gJ2F3cy1jZGstbGliL2F3cy1ldmVudHMtdGFyZ2V0cyc7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tICdjb25zdHJ1Y3RzJztcblxuZXhwb3J0IGludGVyZmFjZSBTY29yaW5nU3RhY2tQcm9wcyAge1xuICBzdGFnZTogc3RyaW5nOyAgZXZlbnRCdXM6IGV2ZW50cy5FdmVudEJ1cztcbn1cblxuZXhwb3J0IGNsYXNzIFNjb3JpbmdTdGFjayBleHRlbmRzIENvbnN0cnVjdCB7XG4gIHB1YmxpYyByZWFkb25seSBzY29yZXNMYW1iZGE6IGxhbWJkYS5GdW5jdGlvbjtcbiAgcHVibGljIHJlYWRvbmx5IGV4ZXJjaXNlc0xhbWJkYTogbGFtYmRhLkZ1bmN0aW9uO1xuICBwdWJsaWMgcmVhZG9ubHkgc2NvcmVzVGFibGU6IGR5bmFtb2RiLlRhYmxlO1xuICBwdWJsaWMgcmVhZG9ubHkgc2NvcmluZ1N5c3RlbXNUYWJsZTogZHluYW1vZGIuVGFibGU7XG4gIHB1YmxpYyByZWFkb25seSBsZWFkZXJib2FyZENhY2hlVGFibGU6IGR5bmFtb2RiLlRhYmxlO1xuICBwdWJsaWMgcmVhZG9ubHkgZXhlcmNpc2VMaWJyYXJ5VGFibGU6IGR5bmFtb2RiLlRhYmxlO1xuICBwdWJsaWMgcmVhZG9ubHkgc2NvcmluZ0V2ZW50QnVzOiBldmVudHMuRXZlbnRCdXM7XG5cbiAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM6IFNjb3JpbmdTdGFja1Byb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkKTtcblxuICAgIC8vIERvbWFpbi1zcGVjaWZpYyBFdmVudEJyaWRnZSBCdXNcbiAgICB0aGlzLnNjb3JpbmdFdmVudEJ1cyA9IG5ldyBldmVudHMuRXZlbnRCdXModGhpcywgJ1Njb3JpbmdFdmVudEJ1cycsIHtcbiAgICAgIGV2ZW50QnVzTmFtZTogYHNjb3JpbmctZG9tYWluLSR7cHJvcHMuc3RhZ2V9YCxcbiAgICB9KTtcblxuICAgIC8vIFNjb3JlcyBUYWJsZVxuICAgIHRoaXMuc2NvcmVzVGFibGUgPSBuZXcgZHluYW1vZGIuVGFibGUodGhpcywgJ1Njb3Jlc1RhYmxlJywge1xuICAgICAgcGFydGl0aW9uS2V5OiB7IG5hbWU6ICdldmVudElkJywgdHlwZTogZHluYW1vZGIuQXR0cmlidXRlVHlwZS5TVFJJTkcgfSxcbiAgICAgIHNvcnRLZXk6IHsgbmFtZTogJ3Njb3JlSWQnLCB0eXBlOiBkeW5hbW9kYi5BdHRyaWJ1dGVUeXBlLlNUUklORyB9LFxuICAgICAgYmlsbGluZ01vZGU6IGR5bmFtb2RiLkJpbGxpbmdNb2RlLlBBWV9QRVJfUkVRVUVTVCxcbiAgICAgIHJlbW92YWxQb2xpY3k6IGNkay5SZW1vdmFsUG9saWN5LkRFU1RST1ksXG4gICAgfSk7XG5cbiAgICB0aGlzLnNjb3Jlc1RhYmxlLmFkZEdsb2JhbFNlY29uZGFyeUluZGV4KHtcbiAgICAgIGluZGV4TmFtZTogJ2F0aGxldGUtc2NvcmVzLWluZGV4JyxcbiAgICAgIHBhcnRpdGlvbktleTogeyBuYW1lOiAnYXRobGV0ZUlkJywgdHlwZTogZHluYW1vZGIuQXR0cmlidXRlVHlwZS5TVFJJTkcgfSxcbiAgICAgIHNvcnRLZXk6IHsgbmFtZTogJ2V2ZW50SWQnLCB0eXBlOiBkeW5hbW9kYi5BdHRyaWJ1dGVUeXBlLlNUUklORyB9LFxuICAgIH0pO1xuXG4gICAgLy8gU2NvcmluZyBTeXN0ZW1zIFRhYmxlXG4gICAgdGhpcy5zY29yaW5nU3lzdGVtc1RhYmxlID0gbmV3IGR5bmFtb2RiLlRhYmxlKHRoaXMsICdTY29yaW5nU3lzdGVtc1RhYmxlJywge1xuICAgICAgcGFydGl0aW9uS2V5OiB7IG5hbWU6ICdldmVudElkJywgdHlwZTogZHluYW1vZGIuQXR0cmlidXRlVHlwZS5TVFJJTkcgfSxcbiAgICAgIHNvcnRLZXk6IHsgbmFtZTogJ3Njb3JpbmdTeXN0ZW1JZCcsIHR5cGU6IGR5bmFtb2RiLkF0dHJpYnV0ZVR5cGUuU1RSSU5HIH0sXG4gICAgICBiaWxsaW5nTW9kZTogZHluYW1vZGIuQmlsbGluZ01vZGUuUEFZX1BFUl9SRVFVRVNULFxuICAgICAgcmVtb3ZhbFBvbGljeTogY2RrLlJlbW92YWxQb2xpY3kuREVTVFJPWSxcbiAgICB9KTtcblxuICAgIC8vIExlYWRlcmJvYXJkIENhY2hlIFRhYmxlXG4gICAgdGhpcy5sZWFkZXJib2FyZENhY2hlVGFibGUgPSBuZXcgZHluYW1vZGIuVGFibGUodGhpcywgJ0xlYWRlcmJvYXJkQ2FjaGVUYWJsZScsIHtcbiAgICAgIHBhcnRpdGlvbktleTogeyBuYW1lOiAnbGVhZGVyYm9hcmRJZCcsIHR5cGU6IGR5bmFtb2RiLkF0dHJpYnV0ZVR5cGUuU1RSSU5HIH0sXG4gICAgICBiaWxsaW5nTW9kZTogZHluYW1vZGIuQmlsbGluZ01vZGUuUEFZX1BFUl9SRVFVRVNULFxuICAgICAgdGltZVRvTGl2ZUF0dHJpYnV0ZTogJ3R0bCcsXG4gICAgICByZW1vdmFsUG9saWN5OiBjZGsuUmVtb3ZhbFBvbGljeS5ERVNUUk9ZLFxuICAgIH0pO1xuXG4gICAgdGhpcy5sZWFkZXJib2FyZENhY2hlVGFibGUuYWRkR2xvYmFsU2Vjb25kYXJ5SW5kZXgoe1xuICAgICAgaW5kZXhOYW1lOiAnZXZlbnQtbGVhZGVyYm9hcmRzLWluZGV4JyxcbiAgICAgIHBhcnRpdGlvbktleTogeyBuYW1lOiAnZXZlbnRJZCcsIHR5cGU6IGR5bmFtb2RiLkF0dHJpYnV0ZVR5cGUuU1RSSU5HIH0sXG4gICAgfSk7XG5cbiAgICAvLyBFeGVyY2lzZSBMaWJyYXJ5IFRhYmxlXG4gICAgdGhpcy5leGVyY2lzZUxpYnJhcnlUYWJsZSA9IG5ldyBkeW5hbW9kYi5UYWJsZSh0aGlzLCAnRXhlcmNpc2VMaWJyYXJ5VGFibGUnLCB7XG4gICAgICBwYXJ0aXRpb25LZXk6IHsgbmFtZTogJ2V4ZXJjaXNlSWQnLCB0eXBlOiBkeW5hbW9kYi5BdHRyaWJ1dGVUeXBlLlNUUklORyB9LFxuICAgICAgYmlsbGluZ01vZGU6IGR5bmFtb2RiLkJpbGxpbmdNb2RlLlBBWV9QRVJfUkVRVUVTVCxcbiAgICAgIHJlbW92YWxQb2xpY3k6IGNkay5SZW1vdmFsUG9saWN5LkRFU1RST1ksXG4gICAgfSk7XG5cbiAgICAvLyBTY29yZXMgTGFtYmRhXG4gICAgdGhpcy5zY29yZXNMYW1iZGEgPSBuZXcgbGFtYmRhLkZ1bmN0aW9uKHRoaXMsICdTY29yZXNMYW1iZGEnLCB7XG4gICAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5OT0RFSlNfMThfWCxcbiAgICAgIGhhbmRsZXI6ICdpbmRleC5oYW5kbGVyJyxcbiAgICAgIGNvZGU6IGxhbWJkYS5Db2RlLmZyb21Bc3NldCgnbGFtYmRhL3Njb3JpbmcnKSxcbiAgICAgIHRpbWVvdXQ6IGNkay5EdXJhdGlvbi5zZWNvbmRzKDMwKSxcbiAgICAgIG1lbW9yeVNpemU6IDI1NixcbiAgICAgIGVudmlyb25tZW50OiB7XG4gICAgICAgIFNDT1JFU19UQUJMRTogdGhpcy5zY29yZXNUYWJsZS50YWJsZU5hbWUsXG4gICAgICAgIFNDT1JJTkdfU1lTVEVNU19UQUJMRTogdGhpcy5zY29yaW5nU3lzdGVtc1RhYmxlLnRhYmxlTmFtZSxcbiAgICAgICAgRE9NQUlOX0VWRU5UX0JVUzogdGhpcy5zY29yaW5nRXZlbnRCdXMuZXZlbnRCdXNOYW1lLFxuICAgICAgICBDRU5UUkFMX0VWRU5UX0JVUzogcHJvcHMuZXZlbnRCdXMuZXZlbnRCdXNOYW1lLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIHRoaXMuc2NvcmVzVGFibGUuZ3JhbnRSZWFkV3JpdGVEYXRhKHRoaXMuc2NvcmVzTGFtYmRhKTtcbiAgICB0aGlzLnNjb3JpbmdTeXN0ZW1zVGFibGUuZ3JhbnRSZWFkRGF0YSh0aGlzLnNjb3Jlc0xhbWJkYSk7XG4gICAgdGhpcy5zY29yaW5nRXZlbnRCdXMuZ3JhbnRQdXRFdmVudHNUbyh0aGlzLnNjb3Jlc0xhbWJkYSk7XG4gICAgcHJvcHMuZXZlbnRCdXMuZ3JhbnRQdXRFdmVudHNUbyh0aGlzLnNjb3Jlc0xhbWJkYSk7XG5cbiAgICAvLyBMZWFkZXJib2FyZCBBUEkgTGFtYmRhXG4gICAgY29uc3QgbGVhZGVyYm9hcmRMYW1iZGEgPSBuZXcgbGFtYmRhLkZ1bmN0aW9uKHRoaXMsICdMZWFkZXJib2FyZExhbWJkYScsIHtcbiAgICAgIHJ1bnRpbWU6IGxhbWJkYS5SdW50aW1lLk5PREVKU18xOF9YLFxuICAgICAgaGFuZGxlcjogJ2xlYWRlcmJvYXJkLWFwaS5oYW5kbGVyJyxcbiAgICAgIGNvZGU6IGxhbWJkYS5Db2RlLmZyb21Bc3NldCgnbGFtYmRhL3Njb3JpbmcnKSxcbiAgICAgIHRpbWVvdXQ6IGNkay5EdXJhdGlvbi5zZWNvbmRzKDMwKSxcbiAgICAgIG1lbW9yeVNpemU6IDI1NixcbiAgICAgIGVudmlyb25tZW50OiB7XG4gICAgICAgIExFQURFUkJPQVJEX1RBQkxFOiB0aGlzLmxlYWRlcmJvYXJkQ2FjaGVUYWJsZS50YWJsZU5hbWUsXG4gICAgICAgIFNDT1JFU19UQUJMRTogdGhpcy5zY29yZXNUYWJsZS50YWJsZU5hbWUsXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgdGhpcy5sZWFkZXJib2FyZENhY2hlVGFibGUuZ3JhbnRSZWFkRGF0YShsZWFkZXJib2FyZExhbWJkYSk7XG4gICAgdGhpcy5zY29yZXNUYWJsZS5ncmFudFJlYWREYXRhKGxlYWRlcmJvYXJkTGFtYmRhKTtcblxuICAgIC8vIExlYWRlcmJvYXJkIENhbGN1bGF0b3IgTGFtYmRhXG4gICAgY29uc3QgY2FsY3VsYXRvckxhbWJkYSA9IG5ldyBsYW1iZGEuRnVuY3Rpb24odGhpcywgJ0xlYWRlcmJvYXJkQ2FsY3VsYXRvcicsIHtcbiAgICAgIHJ1bnRpbWU6IGxhbWJkYS5SdW50aW1lLk5PREVKU18xOF9YLFxuICAgICAgaGFuZGxlcjogJ2xlYWRlcmJvYXJkLWNhbGN1bGF0b3IuaGFuZGxlcicsXG4gICAgICBjb2RlOiBsYW1iZGEuQ29kZS5mcm9tQXNzZXQoJ2xhbWJkYS9zY29yaW5nJyksXG4gICAgICB0aW1lb3V0OiBjZGsuRHVyYXRpb24uc2Vjb25kcyg2MCksXG4gICAgICBtZW1vcnlTaXplOiA1MTIsXG4gICAgICBlbnZpcm9ubWVudDoge1xuICAgICAgICBTQ09SRVNfVEFCTEU6IHRoaXMuc2NvcmVzVGFibGUudGFibGVOYW1lLFxuICAgICAgICBMRUFERVJCT0FSRF9UQUJMRTogdGhpcy5sZWFkZXJib2FyZENhY2hlVGFibGUudGFibGVOYW1lLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIHRoaXMuc2NvcmVzVGFibGUuZ3JhbnRSZWFkRGF0YShjYWxjdWxhdG9yTGFtYmRhKTtcbiAgICB0aGlzLmxlYWRlcmJvYXJkQ2FjaGVUYWJsZS5ncmFudFJlYWRXcml0ZURhdGEoY2FsY3VsYXRvckxhbWJkYSk7XG5cbiAgICAvLyBFdmVudEJyaWRnZSBydWxlIGZvciBsZWFkZXJib2FyZCB1cGRhdGVzXG4gICAgbmV3IGV2ZW50cy5SdWxlKHRoaXMsICdTY29yZUNhbGN1bGF0ZWRSdWxlJywge1xuICAgICAgZXZlbnRCdXM6IHRoaXMuc2NvcmluZ0V2ZW50QnVzLFxuICAgICAgZXZlbnRQYXR0ZXJuOiB7XG4gICAgICAgIHNvdXJjZTogWydzY29yaW5nYW1lcy5zY29yZXMnXSxcbiAgICAgICAgZGV0YWlsVHlwZTogWydTY29yZUNhbGN1bGF0ZWQnXSxcbiAgICAgIH0sXG4gICAgICB0YXJnZXRzOiBbbmV3IHRhcmdldHMuTGFtYmRhRnVuY3Rpb24oY2FsY3VsYXRvckxhbWJkYSldLFxuICAgIH0pO1xuXG4gICAgLy8gU2NvcmluZyBTeXN0ZW1zIExhbWJkYVxuICAgIGNvbnN0IHNjb3JpbmdTeXN0ZW1zTGFtYmRhID0gbmV3IGxhbWJkYS5GdW5jdGlvbih0aGlzLCAnU2NvcmluZ1N5c3RlbXNMYW1iZGEnLCB7XG4gICAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5OT0RFSlNfMThfWCxcbiAgICAgIGhhbmRsZXI6ICdzeXN0ZW1zLmhhbmRsZXInLFxuICAgICAgY29kZTogbGFtYmRhLkNvZGUuZnJvbUFzc2V0KCdsYW1iZGEvc2NvcmluZycpLFxuICAgICAgdGltZW91dDogY2RrLkR1cmF0aW9uLnNlY29uZHMoMzApLFxuICAgICAgbWVtb3J5U2l6ZTogMjU2LFxuICAgICAgZW52aXJvbm1lbnQ6IHtcbiAgICAgICAgU0NPUklOR19TWVNURU1TX1RBQkxFOiB0aGlzLnNjb3JpbmdTeXN0ZW1zVGFibGUudGFibGVOYW1lLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIHRoaXMuc2NvcmluZ1N5c3RlbXNUYWJsZS5ncmFudFJlYWRXcml0ZURhdGEoc2NvcmluZ1N5c3RlbXNMYW1iZGEpO1xuXG4gICAgLy8gRXhlcmNpc2UgTGlicmFyeSBMYW1iZGFcbiAgICB0aGlzLmV4ZXJjaXNlc0xhbWJkYSA9IG5ldyBsYW1iZGEuRnVuY3Rpb24odGhpcywgJ0V4ZXJjaXNlc0xhbWJkYScsIHtcbiAgICAgIHJ1bnRpbWU6IGxhbWJkYS5SdW50aW1lLk5PREVKU18xOF9YLFxuICAgICAgaGFuZGxlcjogJ2V4ZXJjaXNlcy5oYW5kbGVyJyxcbiAgICAgIGNvZGU6IGxhbWJkYS5Db2RlLmZyb21Bc3NldCgnbGFtYmRhL3Njb3JpbmcnKSxcbiAgICAgIHRpbWVvdXQ6IGNkay5EdXJhdGlvbi5zZWNvbmRzKDMwKSxcbiAgICAgIG1lbW9yeVNpemU6IDI1NixcbiAgICAgIGVudmlyb25tZW50OiB7XG4gICAgICAgIEVYRVJDSVNFX0xJQlJBUllfVEFCTEU6IHRoaXMuZXhlcmNpc2VMaWJyYXJ5VGFibGUudGFibGVOYW1lLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIHRoaXMuZXhlcmNpc2VMaWJyYXJ5VGFibGUuZ3JhbnRSZWFkV3JpdGVEYXRhKHRoaXMuZXhlcmNpc2VzTGFtYmRhKTtcblxuICAgIC8vIE91dHB1dHNcbiAgfVxufVxuIl19